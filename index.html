<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body {
  font-family: Arial, sans-serif;
  background:#f5f6fa;
  margin:0;
  padding:0;
  transition: background 0.3s, color 0.3s;
}

/* 顶部导航栏 */
.navbar {
  position: fixed;
  top:0; left:0; right:0;
  height:60px;
  background:#3b82f6;
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:0 20px;
  color:white;
  z-index: 1000;
}
.navbar .logo {
  font-weight:bold;
  font-size:18px;
}
.navbar .title {
  font-size:18px;
  font-weight:500;
}
.navbar .toggle-btn {
  padding:6px 12px;
  border:none;
  border-radius:6px;
  cursor:pointer;
  background:#2563eb;
  color:white;
}

/* 页面内容下移，避免被 navbar 遮挡 */
.content {
  padding:80px 20px 20px 20px;
}

.grid {
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(300px,1fr));
  gap:20px;
}

.card {
  background:white;
  border-radius:16px;
  padding:20px;
  box-shadow:0 4px 10px rgba(0,0,0,0.05);
  transition:background 0.3s, color 0.3s;
}

.card .title {
  font-size:14px;
  color:#888;
  margin-bottom:6px;
}

.value {
  font-size:32px;
  font-weight:bold;
}

.usd-text {
  font-size:14px;
  color:#888;
  margin-left:6px;
}

.positive { color:#16a34a; font-size:14px; }
.negative { color:red; font-size:14px; }

.dark-mode { background:#1f2937; color:#f9fafb; }
.dark-mode .card { background:#374151; color:#f9fafb; }
.dark-mode .card .title { color:#d1d5db; }
.dark-mode .usd-text { color:#9ca3af; }

@media (max-width: 600px) {
  .grid > .card { grid-column: span 1 !important; }
}
</style>
</head>
<body>

<!-- 顶部导航栏 -->
<div class="navbar">
  <div class="logo">🌐</div>
  <div class="title">NightEchoo Dashboard</div>
  <button class="toggle-btn" onclick="toggleDarkMode()">🌙</button>
</div>

<div class="content">
  <div class="grid">
    <!-- Now 卡片 -->
    <div class="card">
      <div class="title">Sol Balance</div>
      <div class="value" id="sol-balance">Loading...</div>
      <div id="sol-change">...</div>
      <button id="refresh-btn" style="margin-top:10px; padding:6px 12px; border:none; border-radius:6px; background:#3b82f6; color:white; cursor:pointer;">
        刷新
      </button>
    </div>
    
    <!-- 进度条 -->
    <div class="card">
      <div class="title">每日 10% 目标</div>
      <div class="progress-bar" style="background:#e5e7eb; border-radius:10px; overflow:hidden; height:12px; margin-top:6px;">
        <div id="sol-progress" class="progress" style="background:#3b82f6; height:12px; width:0%;"></div>
      </div>
      <div id="sol-progress-text" style="font-size:12px; color:#888; margin-top:4px;">...</div>
    </div>

    <!-- 七天余额变化折线图 -->
    <div class="card" style="grid-column: span 2;">
      <div class="title">7天余额变化</div>
      <canvas id="balanceChart" height="200"></canvas>
    </div>
  </div>
</div>

<script>
  const WALLET_ADDRESS = 'A9NBEQeCYzvqidFnh7UVZsBrW2T5df4cqnBjxCBQRJ88';
  const RPC_URL = 'https://mainnet.helius-rpc.com/?api-key=225e1777-98e1-499f-9b14-945da0b99067';
  
  // 刷新按钮事件
  document.getElementById('refresh-btn').addEventListener('click', () => {
    fetchSolBalance();  // 拉取实时数据
    drawBalanceChart(); // 更新折线图
  });
  
    
  // 获取当前余额，先从 balance.json 缓存显示
  async function fetchSolBalance() {
    let fallbackData = null;
  
    // 先读取缓存 balance.json
    try {
      const balanceResp = await fetch('balance.json');
      fallbackData = await balanceResp.json();
      if (fallbackData) {
        document.getElementById('sol-balance').innerHTML =
          `${fallbackData.balance} SOL <span class="usd-text">($${fallbackData.usd})</span>`;
        document.getElementById('sol-change').innerText =
          `上次更新: ${fallbackData.updated}`;
      }
    } catch (e) {
      console.warn("无法加载 balance.json，本地无缓存");
    }
  
    // 拉实时数据
    try {
      const resp = await fetch(RPC_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          jsonrpc: '2.0',
          id: 1,
          method: 'getBalance',
          params: [WALLET_ADDRESS, { commitment: 'finalized' }]
        })
      });
      const json = await resp.json();
      const sol = (json.result.value / 1e9).toFixed(3);
  
      const priceResp = await fetch('https://api.coingecko.com/api/v3/simple/price?ids=solana&vs_currencies=usd');
      const priceData = await priceResp.json();
      const usd = (sol * priceData.solana.usd).toFixed(2);
  
      const now = new Date().toLocaleString('zh-CN', { hour12: false });
      document.getElementById('sol-balance').innerHTML =
        `${sol} SOL <span class="usd-text">($${usd})</span>`;
  
      // ✅ 计算环比变化
      try {
        const balancesResp = await fetch('balances.json');
        const balances = await balancesResp.json();
        const todaysol = parseFloat(balances[balances.length - 1]?.sol || sol);
        const yesterdaysol = parseFloat(balances[balances.length - 2]?.sol || sol);
        const changePercent = (((todaysol - yesterdaysol) / yesterdaysol) * 100).toFixed(2);
        const changeEl = document.getElementById('sol-change');
        if (changePercent >= 0) {
          changeEl.className = 'positive';
          changeEl.innerText = `环比昨日 ▲${changePercent}%`;
        } else {
          changeEl.className = 'negative';
          changeEl.innerText = `环比昨日 ▼${Math.abs(changePercent)}%`;
        }
      } catch(e) {
        console.warn("环比计算失败", e);
      }
  
      // 进度条逻辑保持不变
      try {
        const balancesResp = await fetch('balances.json');
        const balances = await balancesResp.json();
        const morningBalance = parseFloat(balances[balances.length - 1]?.sol || sol);
        const target = (morningBalance * 1.1).toFixed(3);
        const currentSol = parseFloat(sol);
        let progressPercent = ((currentSol - morningBalance) / (target - morningBalance) * 100).toFixed(1);
        progressPercent = Math.max(progressPercent, 0);
        document.getElementById('sol-progress').style.width = progressPercent + '%';
        document.getElementById('sol-progress-text').innerText = `${progressPercent}% (目标: ${target} SOL)`;
      } catch(e) {
        console.warn("进度条计算失败", e);
      }
  
    } catch (err) {
      console.error("实时查询失败，继续显示缓存", err);
    }
  }
  
  async function updateFromCache() {
    try {
      const resp = await fetch('balance.json');
      const data = await resp.json();
  
      const sol = parseFloat(data.balance);
      const usd = parseFloat(data.usd);
      const updated = data.updated;
  
      // 显示余额
      document.getElementById('sol-balance').innerHTML = `${sol} SOL <span class="usd-text">($${usd})</span>`;
      document.getElementById('sol-change').innerText = `上次更新: ${updated}`;
  
      // 计算进度条
      const morningBalance = sol; // 暂时以缓存余额作为早上7点的数据
      const target = (morningBalance * 1.1).toFixed(3);
      const currentSol = sol;
  
      let progressPercent = ((currentSol - morningBalance) / (target - morningBalance) * 100).toFixed(1);
      if (!isFinite(progressPercent)) progressPercent = 0; // 避免除以0
  
      document.getElementById('sol-progress').style.width = progressPercent + '%';
      document.getElementById('sol-progress-text').innerText = `${progressPercent}% (目标: ${target} SOL)`;
  
    } catch (e) {
      console.error("无法读取 balance.json", e);
    }
  }

  // 绘制七天折线图
  async function drawBalanceChart() {
    try {
      const resp = await fetch('balances.json');
      const data = await resp.json();
      const labels = data.map(item => item.date);
      const values = data.map(item => parseFloat(item.sol).toFixed(3));
      const ctx = document.getElementById('balanceChart').getContext('2d');
      new Chart(ctx, {
        type: 'line',
        data: {
          labels,
          datasets: [{
            label: 'SOL余额',
            data: values,
            borderColor: '#3b82f6',
            fill: false,
            tension: 0.2
          }]
        },
        options: {
          scales: {
            y: {
              beginAtZero: false,
              ticks: { callback: function(value){ return parseFloat(value).toFixed(3); } }
            }
          },
          plugins: {
            tooltip: {
              callbacks: {
                label: function(context){ return context.dataset.label + ': ' + parseFloat(context.raw).toFixed(3); }
              }
            }
          }
        }
      });
    } catch(err) {
      console.error("折线图加载失败", err);
    }
  }
  
  // 页面加载时先用缓存更新
  updateFromCache();
  
  // 然后尝试拉取实时数据
  fetchSolBalance(); // 如果接口可用，会覆盖缓存数据

  drawBalanceChart();
  setInterval(fetchSolBalance, 30000);
  
  function toggleDarkMode() { document.body.classList.toggle('dark-mode'); }
</script>

</body>
</html>
