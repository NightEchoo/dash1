<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body { font-family: Arial, sans-serif; background:#f5f6fa; margin:0; padding:0; transition: background 0.3s, color 0.3s; }
.navbar { position: fixed; top:0; left:0; right:0; height:60px; background:#3b82f6; display:flex; align-items:center; justify-content:space-between; padding:0 20px; color:white; z-index:1000; }
.navbar .logo { font-weight:bold; font-size:18px; }
.navbar .title { font-size:18px; font-weight:500; }
.navbar .toggle-btn { padding:6px 12px; border:none; border-radius:6px; cursor:pointer; background:#2563eb; color:white; }
.content { padding:80px 20px 20px 20px; }
.grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(300px,1fr)); gap:20px; }
.card { background:white; border-radius:16px; padding:20px; box-shadow:0 4px 10px rgba(0,0,0,0.05); transition:background 0.3s, color 0.3s; }
.card .title { font-size:14px; color:#888; margin-bottom:6px; }
.value { font-size:32px; font-weight:bold; }
.usd-text { font-size:14px; color:#888; margin-left:6px; }
.positive { color:#16a34a; font-size:14px; }
.negative { color:red; font-size:14px; }
.dark-mode { background:#1f2937; color:#f9fafb; }
.dark-mode .card { background:#374151; color:#f9fafb; }
.dark-mode .card .title { color:#d1d5db; }
.dark-mode .usd-text { color:#9ca3af; }
@media (max-width: 600px) { .grid > .card { grid-column: span 1 !important; } }
</style>
</head>
<body>

<div class="navbar">
  <div class="logo">ğŸŒ</div>
  <div class="title">NightEchoo Dashboard</div>
  <button class="toggle-btn" onclick="toggleDarkMode()">ğŸŒ™</button>
</div>

<div class="content">
  <div class="grid">
    <div class="card">
      <div class="title">Sol Balance</div>
      <div class="value" id="sol-balance">Loading...</div>
      <div id="sol-change">...</div>
      <button id="refresh-btn" style="margin-top:10px; padding:6px 12px; border:none; border-radius:6px; background:#3b82f6; color:white; cursor:pointer;">åˆ·æ–°</button>
    </div>

    <div class="card">
      <div class="title">æ¯æ—¥ 10% ç›®æ ‡</div>
      <div class="progress-bar" style="background:#e5e7eb; border-radius:10px; overflow:hidden; height:12px; margin-top:6px;">
        <div id="sol-progress" class="progress" style="background:#3b82f6; height:12px; width:0%;"></div>
      </div>
      <div id="sol-progress-text" style="font-size:12px; color:#888; margin-top:4px;">...</div>
    </div>

    <div class="card" style="grid-column: span 2;">
      <div class="title">7å¤©ä½™é¢å˜åŒ–</div>
      <canvas id="balanceChart" height="200"></canvas>
    </div>
  </div>
</div>

<script>
const WALLET_ADDRESS = 'A9NBEQeCYzvqidFnh7UVZsBrW2T5df4cqnBjxCBQRJ88';
const RPC_URL = 'https://mainnet.helius-rpc.com/?api-key=225e1777-98e1-499f-9b14-945da0b99067';

const refreshBtn = document.getElementById('refresh-btn');
refreshBtn.addEventListener('click', () => {
  fetchSolBalance();
  drawBalanceChart();
});

// ä½¿ç”¨ LocalStorage æ˜¾ç¤ºç¼“å­˜
function loadFromLocalStorage() {
  try {
    const cached = JSON.parse(localStorage.getItem('balanceData'));
    if (cached) {
      const currentSol = parseFloat(cached.balance);
      const usd = parseFloat(cached.usd);
      const updated = cached.updated;
      document.getElementById('sol-balance').innerHTML = `${currentSol} SOL <span class="usd-text">($${usd})</span>`;
      document.getElementById('sol-change').innerText = `ä¸Šæ¬¡æ›´æ–°: ${updated}`;

      // è¿›åº¦æ¡
      const morningBalance = parseFloat(cached.morningBalance || currentSol);
      const target = (morningBalance * 1.1).toFixed(3);
      let progressPercent = ((currentSol - morningBalance)/(target - morningBalance) * 100).toFixed(1);
      if (!isFinite(progressPercent)) progressPercent = 0;
      document.getElementById('sol-progress').style.width = progressPercent + '%';
      document.getElementById('sol-progress-text').innerText = `${progressPercent}% (ç›®æ ‡: ${target} SOL)`;
    }
  } catch(e) {
    console.warn("LocalStorage æ— ç¼“å­˜", e);
  }
}

// æ‹‰å– balance.json å¹¶æ›´æ–° LocalStorage
async function fetchBalanceJson() {
  try {
    const resp = await fetch('balance.json');
    const data = await resp.json();
    // æ›´æ–° LocalStorage
    localStorage.setItem('balanceData', JSON.stringify(data));
    return data;
  } catch(e) {
    console.warn("æ— æ³•è¯»å– balance.json", e);
    return null;
  }
}

// æ‹‰å®æ—¶ SOL å’Œ USD
async function fetchSolBalance() {
  let fallback = await fetchBalanceJson();

  // å…ˆç”¨ç¼“å­˜å±•ç¤º
  if(fallback){
    document.getElementById('sol-balance').innerHTML =
      `${fallback.balance} SOL <span class="usd-text">($${fallback.usd})</span>`;
  }

  try {
    const resp = await fetch(RPC_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        jsonrpc: '2.0',
        id: 1,
        method: 'getBalance',
        params: [WALLET_ADDRESS, { commitment: 'finalized' }]
      })
    });
    const json = await resp.json();
    const sol = (json.result.value / 1e9).toFixed(3);

    const priceResp = await fetch('https://api.coingecko.com/api/v3/simple/price?ids=solana&vs_currencies=usd');
    const priceData = await priceResp.json();
    const usd = (sol * priceData.solana.usd).toFixed(2);
    const now = new Date().toLocaleString('zh-CN', { hour12:false });

    // æ›´æ–°ç•Œé¢
    document.getElementById('sol-balance').innerHTML = `${sol} SOL <span class="usd-text">($${usd})</span>`;
    document.getElementById('sol-change').innerText = `ä¸Šæ¬¡æ›´æ–°: ${now}`;

    // æ›´æ–° LocalStorage
    const balancesResp = await fetch('balances.json');
    const balances = await balancesResp.json();
    const morningBalance = parseFloat(balances[balances.length-1]?.sol || sol);
    localStorage.setItem('balanceData', JSON.stringify({
      balance: sol,
      usd: usd,
      updated: now,
      morningBalance: morningBalance
    }));

    // è¿›åº¦æ¡
    const target = (morningBalance * 1.1).toFixed(3);
    let progressPercent = ((sol - morningBalance)/(target - morningBalance) * 100).toFixed(1);
    if(!isFinite(progressPercent)) progressPercent=0;
    document.getElementById('sol-progress').style.width = progressPercent + '%';
    document.getElementById('sol-progress-text').innerText = `${progressPercent}% (ç›®æ ‡: ${target} SOL)`;

  } catch(e) {
    console.warn("å®æ—¶æŸ¥è¯¢å¤±è´¥ï¼Œä½¿ç”¨ç¼“å­˜", e);
  }
}

// ç»˜åˆ¶ä¸ƒå¤©æŠ˜çº¿å›¾
async function drawBalanceChart() {
  let data = null;
  
  // å…ˆå°è¯•ä» LocalStorage è·å–
  const cachedHistory = localStorage.getItem('balanceHistory');
  if (cachedHistory) {
    try { data = JSON.parse(cachedHistory); } 
    catch(e){ console.warn("LocalStorageæŠ˜çº¿æ•°æ®è§£æå¤±è´¥", e); }
  }

  // å¦‚æœ LocalStorage æ²¡æœ‰ï¼Œå† fetch balances.json
  if (!data) {
    try {
      const resp = await fetch('balances.json');
      data = await resp.json();
      localStorage.setItem('balanceHistory', JSON.stringify(data));
    } catch(e){ console.warn("æŠ˜çº¿å›¾æ•°æ®åŠ è½½å¤±è´¥", e); return; }
  }

  const labels = data.map(d => d.date);
  const values = data.map(d => parseFloat(d.sol).toFixed(3));
  const ctx = document.getElementById('balanceChart').getContext('2d');

  // æ¸…ç†ä¹‹å‰å›¾è¡¨ï¼ˆé˜²æ­¢é‡å¤æ¸²æŸ“ï¼‰
  if (window.balanceChartInstance) window.balanceChartInstance.destroy();

  window.balanceChartInstance = new Chart(ctx, {
    type: 'line',
    data: {
      labels,
      datasets: [{
        label: 'SOLä½™é¢',
        data: values,
        borderColor: '#3b82f6',
        fill: false,
        tension: 0.2
      }]
    },
    options: {
      scales: {
        y: {
          beginAtZero: false,
          ticks: { callback: v => parseFloat(v).toFixed(3) }
        }
      },
      plugins: {
        tooltip: {
          callbacks: { label: ctx => 'SOLä½™é¢: ' + parseFloat(ctx.raw).toFixed(3) }
        }
      }
    }
  });
}

// é¡µé¢åŠ è½½
loadFromLocalStorage();
fetchSolBalance();
drawBalanceChart();
setInterval(fetchSolBalance, 30000);

function toggleDarkMode(){ document.body.classList.toggle('dark-mode'); }
</script>

</body>
</html>
