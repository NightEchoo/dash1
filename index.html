<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body { font-family: Arial, sans-serif; background:#f5f6fa; margin:0; padding:20px; transition:background 0.3s, color 0.3s; }
.grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(300px,1fr)); gap:20px; }
.card { background:white; border-radius:16px; padding:20px; box-shadow:0 4px 10px rgba(0,0,0,0.05); transition:background 0.3s, color 0.3s; }
.title { font-size:14px; color:#888; margin-bottom:6px; }
.value { font-size:32px; font-weight:bold; }
.positive { color:#16a34a; font-size:14px; }
.dark-mode { background:#1f2937; color:#f9fafb; }
.dark-mode .card { background:#374151; color:#f9fafb; }
.dark-mode .title { color:#d1d5db; }
.toggle-btn { position:fixed; top:20px; right:20px; padding:8px 16px; border:none; border-radius:8px; cursor:pointer; background:#3b82f6; color:white; }
</style>
</head>
<body>
<button class="toggle-btn" onclick="toggleDarkMode()">🌙 切换模式</button>

<div class="grid">
  <!-- Now 卡片 -->
    <div class="card">
    <div class="title">Now</div>
    <!-- sol-balance 显示 SOL + USD -->
    <div class="value" id="sol-balance">Loading...</div>
    <!-- sol-usd 改为显示环比百分比 -->
    <div class="positive" id="sol-change">...</div>
  </div>

  <!-- 七天余额变化折线图 -->
  <div class="card" style="grid-column: span 2;">
    <div class="title">7天余额变化</div>
    <canvas id="balanceChart" height="200"></canvas>
  </div>
</div>

<script>
  const WALLET_ADDRESS = 'A9NBEQeCYzvqidFnh7UVZsBrW2T5df4cqnBjxCBQRJ88';
  const RPC_URL = 'https://mainnet.helius-rpc.com/?api-key=225e1777-98e1-499f-9b14-945da0b99067';
  
  // 获取当前余额并显示
  async function fetchSolBalance() {
    // 获取当前余额
    const resp = await fetch(RPC_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        jsonrpc: '2.0',
        id: 1,
        method: 'getBalance',
        params: [WALLET_ADDRESS, { commitment: 'finalized' }]
      })
    });
    const json = await resp.json();
    const lamports = json.result.value;
    const sol = (lamports / 1e9).toFixed(3);
  
    // 获取 SOL-USD 价格
    const priceResp = await fetch('https://api.coingecko.com/api/v3/simple/price?ids=solana&vs_currencies=usd');
    const priceData = await priceResp.json();
    const usd = (sol * priceData.solana.usd).toFixed(2);
  
    // 更新 Now 卡片显示 SOL + USD
    document.getElementById('sol-balance').innerText = `${sol} SOL ($${usd})`;
  
    // 获取昨天的余额，计算环比百分比
    const balanceResp = await fetch('balances.json');
    const balances = await balanceResp.json();
    const yesterday = balances[balances.length - 2]?.sol || sol; // 倒数第二条为昨天
    const changePercent = (((sol - yesterday) / yesterday) * 100).toFixed(2);
  
    const changeText = changePercent >= 0 ? `环比昨日 ▲${changePercent}%` : `环比昨日 ▼${Math.abs(changePercent)}%`;
    document.getElementById('sol-change').innerText = changeText;
  }
  
  // 绘制七天折线图
  async function drawBalanceChart() {
    const resp = await fetch('balances.json'); // GitHub Pages 上的 JSON 文件
    const data = await resp.json();
  
    const labels = data.map(item => item.date);
    const values = data.map(item => item.sol);
  
    const ctx = document.getElementById('balanceChart').getContext('2d');
    new Chart(ctx, {
      type: 'line',
      data: {
        labels,
        datasets: [{
          label: 'SOL余额',
          data: values,
          borderColor: '#3b82f6',
          fill: false,
          tension: 0.2
        }]
      },
      options: {
        scales: { y: { beginAtZero: false } }
      }
    });
  }
  
  // 页面加载
  fetchSolBalance();
  drawBalanceChart();
  
  // 可选：每 30 秒刷新当前余额
  setInterval(fetchSolBalance, 30000);
  
  function toggleDarkMode() { document.body.classList.toggle('dark-mode'); }
</script>
</body>
</html>
