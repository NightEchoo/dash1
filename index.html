<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body { font-family: Arial, sans-serif; background:#f5f6fa; margin:0; padding:0; transition: background 0.3s, color 0.3s; }
.navbar { position: fixed; top:0; left:0; right:0; height:60px; background:#3b82f6; display:flex; align-items:center; justify-content:space-between; padding:0 20px; color:white; z-index:1000; }
.navbar .logo { font-weight:bold; font-size:18px; }
.navbar .title { font-size:18px; font-weight:500; }
.navbar .toggle-btn { padding:6px 12px; border:none; border-radius:6px; cursor:pointer; background:#2563eb; color:white; }
.content { padding:80px 20px 20px 20px; }
.grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(300px,1fr)); gap:20px; }
.card { background:white; border-radius:16px; padding:20px; box-shadow:0 4px 10px rgba(0,0,0,0.05); transition:background 0.3s, color 0.3s; }
.card .title { font-size:14px; color:#888; margin-bottom:6px; }
.value { font-size:32px; font-weight:bold; cursor:pointer; }
.usd-text { font-size:14px; color:#888; margin-left:6px; }
.positive { color:#16a34a; font-size:14px; }
.negative { color:red; font-size:14px; }
.dark-mode { background:#1f2937; color:#f9fafb; }
.dark-mode .card { background:#374151; color:#f9fafb; }
.dark-mode .card .title { color:#d1d5db; }
.dark-mode .usd-text { color:#9ca3af; }
@media (max-width: 600px) { .grid > .card { grid-column: span 1 !important; } }
</style>
</head>
<body>

<div class="navbar">
  <div class="logo">🌐</div>
  <div class="title">NightEchoo Dashboard</div>
  <button class="toggle-btn" onclick="toggleDarkMode()">🌙</button>
</div>

<div class="content">
  <div class="grid">
    <!-- 余额 -->
    <div class="card">
      <div class="title">Sol Balance</div>
      <div class="value" id="sol-balance">Loading...</div>
      <div id="sol-change">...</div>
      <button id="refresh-btn" style="margin-top:10px; padding:6px 12px; border:none; border-radius:6px; background:#3b82f6; color:white; cursor:pointer;">刷新</button>
    </div>

    <!-- 进度条 -->
    <div class="card">
      <div class="title">每日 10% 目标</div>
      <div class="progress-bar" style="background:#e5e7eb; border-radius:10px; overflow:hidden; height:12px; margin-top:6px;">
        <div id="sol-progress" class="progress" style="background:#3b82f6; height:12px; width:0%;"></div>
      </div>
      <div id="sol-progress-text" style="font-size:12px; color:#888; margin-top:4px;">...</div>
    </div>

    <!-- 7天折线图 -->
    <div class="card" style="grid-column: span 2;">
      <div class="title">7天余额变化</div>
      <canvas id="balanceChart7" height="200"></canvas>
      <div id="ring-change-7" style="margin-top:10px;font-size:14px;"></div>
    </div>

    <!-- 30天折线图 -->
    <div class="card" style="grid-column: span 2;">
      <div class="title">30天余额变化</div>
      <canvas id="balanceChart30" height="200"></canvas>
      <div id="ring-change-30" style="margin-top:10px;font-size:14px;"></div>
    </div>
  </div>
</div>

<script>
const WALLET_ADDRESS = 'A9NBEQeCYzvqidFnh7UVZsBrW2T5df4cqnBjxCBQRJ88';
const RPC_URL = 'https://mainnet.helius-rpc.com/?api-key=225e1777-98e1-499f-9b14-945da0b99067'; 
const refreshBtn = document.getElementById('refresh-btn');
const solBalanceEl = document.getElementById('sol-balance');

let usdPrice = 0;       // USD 当前价
let cnyPrice = 0;       // CNY 当前价
let solAmount = 0;      // SOL 数量
let showingUSD = true;  // 当前显示 USD

refreshBtn.addEventListener('click', () => {
  fetchSolBalance();
  drawBalanceCharts();
});

// 点击金额切换 USD/CNY
solBalanceEl.addEventListener('click', () => {
  if (solAmount === 0) return;
  showingUSD = !showingUSD;
  updateBalanceDisplay();
});

// 更新显示
function updateBalanceDisplay() {
  if (showingUSD) {
    solBalanceEl.innerHTML = `${solAmount} SOL <span class="usd-text">($${usdPrice})</span>`;
  } else {
    solBalanceEl.innerHTML = `${solAmount} SOL <span class="usd-text">(¥${cnyPrice})</span>`;
  }
}

// 更新余额 UI + 进度条
function updateBalanceUI(sol, usd, updated, morningBalance) {
  solAmount = sol;
  usdPrice = usd;
  updateBalanceDisplay();
  document.getElementById('sol-change').innerText = `上次更新: ${updated}`;

  const target = (morningBalance * 1.1).toFixed(3);
  let progressPercent = ((sol - morningBalance)/(target - morningBalance) * 100).toFixed(1);
  if (!isFinite(progressPercent)) progressPercent = 0;
  progressPercent = Math.max(0, progressPercent);
  document.getElementById('sol-progress').style.width = progressPercent + '%';
  document.getElementById('sol-progress-text').innerText = `${progressPercent}% (目标: ${target} SOL)`;
}

// 从 balance.json 获取缓存数据
async function fetchBalanceJson() {
  try {
    const resp = await fetch('balance.json?' + Date.now());
    return await resp.json();
  } catch(e) {
    console.warn("无法读取 balance.json", e);
    return null;
  }
}

// 获取 USD->CNY 汇率
async function fetchUSDCNYRate() {
  try {
    const resp = await fetch('https://api.exchangerate.host/convert?from=USD&to=CNY');
    const data = await resp.json();
    return data.result;
  } catch(e) {
    console.warn("获取汇率失败", e);
    return 7; // 兜底
  }
}

// 实时拉取 SOL & USD
async function fetchSolBalance() {
  let fallback = await fetchBalanceJson();
  if (fallback) updateBalanceUI(fallback.balance, fallback.usd, fallback.updated, fallback.morningBalance || fallback.balance);

  try {
    // 查询链上余额
    const resp = await fetch(RPC_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ jsonrpc: '2.0', id: 1, method: 'getBalance', params: [WALLET_ADDRESS, { commitment: 'finalized' }] })
    });
    const json = await resp.json();
    const sol = (json.result.value / 1e9).toFixed(3);

    // 查询价格
    const priceResp = await fetch('https://api.coingecko.com/api/v3/simple/price?ids=solana&vs_currencies=usd');
    const priceData = await priceResp.json();
    const usd = (sol * priceData.solana.usd).toFixed(2);

    // 获取 USD->CNY 汇率
    const rate = await fetchUSDCNYRate();
    const cny = (usd * rate).toFixed(2);
    cnyPrice = cny;

    const now = new Date().toLocaleString('zh-CN', { hour12:false });

    // 获取早晨余额
    const balancesResp = await fetch('balances.json?' + Date.now());
    const balances = await balancesResp.json();
    const morningBalance = parseFloat(balances[balances.length-1]?.sol || sol);

    // 更新 UI
    updateBalanceUI(sol, usd, now, morningBalance);

  } catch(e) {
    console.warn("实时查询失败，使用 balance.json 数据", e);
  }
}

// 绘制 7天 和 30天 折线图
async function drawBalanceCharts() {
  let data = null;
  try {
    const resp = await fetch('balances.json?' + Date.now());
    data = await resp.json();
  } catch(e){ console.warn("折线图数据加载失败", e); return; }

  // --- 7天图 ---
  const last7 = data.slice(-7);
  const labels7 = last7.map(d => d.date);
  const values7 = last7.map(d => parseFloat(d.sol).toFixed(3));
  const ctx7 = document.getElementById('balanceChart7').getContext('2d');
  if (window.balanceChart7Instance) window.balanceChart7Instance.destroy();
  window.balanceChart7Instance = new Chart(ctx7, {
    type: 'line',
    data: { labels: labels7, datasets: [{ label: 'SOL余额', data: values7, borderColor: '#3b82f6', fill: false, tension: 0.2 }] },
    options: { scales: { y: { beginAtZero: false } } }
  });
  if (values7.length >= 2) {
    const latest = parseFloat(values7[values7.length-1]);
    const prev = parseFloat(values7[values7.length-2]);
    const diffPercent = ((latest - prev) / prev * 100).toFixed(2);
    document.getElementById("ring-change-7").innerText = diffPercent >= 0
      ? `📈 较昨日增加 ${diffPercent}%`
      : `📉 较昨日减少 ${Math.abs(diffPercent)}%`;
  }

  // --- 30天图 ---
  const last30 = data.slice(-30);
  const labels30 = last30.map(d => d.date);
  const values30 = last30.map(d => parseFloat(d.sol).toFixed(3));
  const ctx30 = document.getElementById('balanceChart30').getContext('2d');
  if (window.balanceChart30Instance) window.balanceChart30Instance.destroy();
  window.balanceChart30Instance = new Chart(ctx30, {
    type: 'line',
    data: { labels: labels30, datasets: [{ label: 'SOL余额', data: values30, borderColor: '#10b981', fill: false, tension: 0.2 }] },
    options: { scales: { y: { beginAtZero: false } } }
  });
  if (values30.length >= 2) {
    const latest = parseFloat(values30[values30.length-1]);
    const prev = parseFloat(values30[values30.length-2]);
    const diffPercent = ((latest - prev) / prev * 100).toFixed(2);
    document.getElementById("ring-change-30").innerText = diffPercent >= 0
      ? `📈 较昨日增加 ${diffPercent}%`
      : `📉 较昨日减少 ${Math.abs(diffPercent)}%`;
  }
}

// 页面初始化
fetchSolBalance();
drawBalanceCharts();
setInterval(fetchSolBalance, 30000);

function toggleDarkMode(){ document.body.classList.toggle('dark-mode'); }
</script>

</body>
</html>
