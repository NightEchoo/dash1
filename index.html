<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body {
  font-family: Arial, sans-serif;
  background:#f5f6fa;
  margin:0;
  padding:0;
  transition: background 0.3s, color 0.3s;
}

/* é¡¶éƒ¨å¯¼èˆªæ  */
.navbar {
  position: fixed;
  top:0; left:0; right:0;
  height:60px;
  background:#3b82f6;
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:0 20px;
  color:white;
  z-index: 1000;
}
.navbar .logo {
  font-weight:bold;
  font-size:18px;
}
.navbar .title {
  font-size:18px;
  font-weight:500;
}
.navbar .toggle-btn {
  padding:6px 12px;
  border:none;
  border-radius:6px;
  cursor:pointer;
  background:#2563eb;
  color:white;
}

/* é¡µé¢å†…å®¹ä¸‹ç§»ï¼Œé¿å…è¢« navbar é®æŒ¡ */
.content {
  padding:80px 20px 20px 20px;
}

.grid {
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(300px,1fr));
  gap:20px;
}

.card {
  background:white;
  border-radius:16px;
  padding:20px;
  box-shadow:0 4px 10px rgba(0,0,0,0.05);
  transition:background 0.3s, color 0.3s;
}

.card .title {
  font-size:14px;
  color:#888;
  margin-bottom:6px;
}

.value {
  font-size:32px;
  font-weight:bold;
}

.usd-text {
  font-size:14px;
  color:#888;
  margin-left:6px;
}

.positive { color:#16a34a; font-size:14px; }
.negative { color:red; font-size:14px; }

.dark-mode { background:#1f2937; color:#f9fafb; }
.dark-mode .card { background:#374151; color:#f9fafb; }
.dark-mode .card .title { color:#d1d5db; }
.dark-mode .usd-text { color:#9ca3af; }

@media (max-width: 600px) {
  .grid > .card { grid-column: span 1 !important; }
}
</style>
</head>
<body>

<!-- é¡¶éƒ¨å¯¼èˆªæ  -->
<div class="navbar">
  <div class="logo">ğŸŒ</div>
  <div class="title">NightEchoo Dashboard</div>
  <button class="toggle-btn" onclick="toggleDarkMode()">ğŸŒ™</button>
</div>

<div class="content">
  <div class="grid">
    <!-- Now å¡ç‰‡ -->
    <div class="card">
      <div class="title">Sol Balance</div>
      <div class="value" id="sol-balance">Loading...</div>
      <div id="sol-change">...</div>
      <button id="refresh-btn" style="margin-top:10px; padding:6px 12px; border:none; border-radius:6px; background:#3b82f6; color:white; cursor:pointer;">
        åˆ·æ–°
      </button>
    </div>
    
    <!-- è¿›åº¦æ¡ -->
    <div class="card">
      <div class="title">æ¯æ—¥ 10% ç›®æ ‡</div>
      <div class="progress-bar" style="background:#e5e7eb; border-radius:10px; overflow:hidden; height:12px; margin-top:6px;">
        <div id="sol-progress" class="progress" style="background:#3b82f6; height:12px; width:0%;"></div>
      </div>
      <div id="sol-progress-text" style="font-size:12px; color:#888; margin-top:4px;">...</div>
    </div>

    <!-- ä¸ƒå¤©ä½™é¢å˜åŒ–æŠ˜çº¿å›¾ -->
    <div class="card" style="grid-column: span 2;">
      <div class="title">7å¤©ä½™é¢å˜åŒ–</div>
      <canvas id="balanceChart" height="200"></canvas>
    </div>
  </div>
</div>

<script>
  const WALLET_ADDRESS = 'A9NBEQeCYzvqidFnh7UVZsBrW2T5df4cqnBjxCBQRJ88';
  const RPC_URL = 'https://mainnet.helius-rpc.com/?api-key=225e1777-98e1-499f-9b14-945da0b99067';
  
  // åˆ·æ–°æŒ‰é’®äº‹ä»¶
  document.getElementById('refresh-btn').addEventListener('click', () => {
    fetchSolBalance();  // æ‹‰å–å®æ—¶æ•°æ®
    drawBalanceChart(); // æ›´æ–°æŠ˜çº¿å›¾
  });
  
    
  // è·å–å½“å‰ä½™é¢ï¼Œå…ˆä» balance.json ç¼“å­˜æ˜¾ç¤º
  async function fetchSolBalance() {
    let fallbackData = null;
  
    // å…ˆè¯»å–ç¼“å­˜ balance.json
    try {
      const balanceResp = await fetch('balance.json');
      fallbackData = await balanceResp.json();
      if (fallbackData) {
        document.getElementById('sol-balance').innerHTML =
          `${fallbackData.balance} SOL <span class="usd-text">($${fallbackData.usd})</span>`;
        document.getElementById('sol-change').innerText =
          `ä¸Šæ¬¡æ›´æ–°: ${fallbackData.updated}`;
      }
    } catch (e) {
      console.warn("æ— æ³•åŠ è½½ balance.jsonï¼Œæœ¬åœ°æ— ç¼“å­˜");
    }
  
    // æ‹‰å®æ—¶æ•°æ®
    try {
      const resp = await fetch(RPC_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          jsonrpc: '2.0',
          id: 1,
          method: 'getBalance',
          params: [WALLET_ADDRESS, { commitment: 'finalized' }]
        })
      });
      const json = await resp.json();
      const sol = (json.result.value / 1e9).toFixed(3);
  
      const priceResp = await fetch('https://api.coingecko.com/api/v3/simple/price?ids=solana&vs_currencies=usd');
      const priceData = await priceResp.json();
      const usd = (sol * priceData.solana.usd).toFixed(2);
  
      const now = new Date().toLocaleString('zh-CN', { hour12: false });
      document.getElementById('sol-balance').innerHTML =
        `${sol} SOL <span class="usd-text">($${usd})</span>`;
  
      // âœ… è®¡ç®—ç¯æ¯”å˜åŒ–
      try {
        const balancesResp = await fetch('balances.json');
        const balances = await balancesResp.json();
        const todaysol = parseFloat(balances[balances.length - 1]?.sol || sol);
        const yesterdaysol = parseFloat(balances[balances.length - 2]?.sol || sol);
        const changePercent = (((todaysol - yesterdaysol) / yesterdaysol) * 100).toFixed(2);
        const changeEl = document.getElementById('sol-change');
        if (changePercent >= 0) {
          changeEl.className = 'positive';
          changeEl.innerText = `ç¯æ¯”æ˜¨æ—¥ â–²${changePercent}%`;
        } else {
          changeEl.className = 'negative';
          changeEl.innerText = `ç¯æ¯”æ˜¨æ—¥ â–¼${Math.abs(changePercent)}%`;
        }
      } catch(e) {
        console.warn("ç¯æ¯”è®¡ç®—å¤±è´¥", e);
      }
  
      // è¿›åº¦æ¡é€»è¾‘ä¿æŒä¸å˜
      try {
        const balancesResp = await fetch('balances.json');
        const balances = await balancesResp.json();
        const morningBalance = parseFloat(balances[balances.length - 1]?.sol || sol);
        const target = (morningBalance * 1.1).toFixed(3);
        const currentSol = parseFloat(sol);
        let progressPercent = ((currentSol - morningBalance) / (target - morningBalance) * 100).toFixed(1);
        progressPercent = Math.max(progressPercent, 0);
        document.getElementById('sol-progress').style.width = progressPercent + '%';
        document.getElementById('sol-progress-text').innerText = `${progressPercent}% (ç›®æ ‡: ${target} SOL)`;
      } catch(e) {
        console.warn("è¿›åº¦æ¡è®¡ç®—å¤±è´¥", e);
      }
  
    } catch (err) {
      console.error("å®æ—¶æŸ¥è¯¢å¤±è´¥ï¼Œç»§ç»­æ˜¾ç¤ºç¼“å­˜", err);
    }
  }
  
  async function updateFromCache() {
    try {
      const resp = await fetch('balance.json');
      const data = await resp.json();
  
      const sol = parseFloat(data.balance);
      const usd = parseFloat(data.usd);
      const updated = data.updated;
  
      // æ˜¾ç¤ºä½™é¢
      document.getElementById('sol-balance').innerHTML = `${sol} SOL <span class="usd-text">($${usd})</span>`;
      document.getElementById('sol-change').innerText = `ä¸Šæ¬¡æ›´æ–°: ${updated}`;
  
      // è®¡ç®—è¿›åº¦æ¡
      const morningBalance = sol; // æš‚æ—¶ä»¥ç¼“å­˜ä½™é¢ä½œä¸ºæ—©ä¸Š7ç‚¹çš„æ•°æ®
      const target = (morningBalance * 1.1).toFixed(3);
      const currentSol = sol;
  
      let progressPercent = ((currentSol - morningBalance) / (target - morningBalance) * 100).toFixed(1);
      if (!isFinite(progressPercent)) progressPercent = 0; // é¿å…é™¤ä»¥0
  
      document.getElementById('sol-progress').style.width = progressPercent + '%';
      document.getElementById('sol-progress-text').innerText = `${progressPercent}% (ç›®æ ‡: ${target} SOL)`;
  
    } catch (e) {
      console.error("æ— æ³•è¯»å– balance.json", e);
    }
  }

  // ç»˜åˆ¶ä¸ƒå¤©æŠ˜çº¿å›¾
  async function drawBalanceChart() {
    try {
      const resp = await fetch('balances.json');
      const data = await resp.json();
      const labels = data.map(item => item.date);
      const values = data.map(item => parseFloat(item.sol).toFixed(3));
      const ctx = document.getElementById('balanceChart').getContext('2d');
      new Chart(ctx, {
        type: 'line',
        data: {
          labels,
          datasets: [{
            label: 'SOLä½™é¢',
            data: values,
            borderColor: '#3b82f6',
            fill: false,
            tension: 0.2
          }]
        },
        options: {
          scales: {
            y: {
              beginAtZero: false,
              ticks: { callback: function(value){ return parseFloat(value).toFixed(3); } }
            }
          },
          plugins: {
            tooltip: {
              callbacks: {
                label: function(context){ return context.dataset.label + ': ' + parseFloat(context.raw).toFixed(3); }
              }
            }
          }
        }
      });
    } catch(err) {
      console.error("æŠ˜çº¿å›¾åŠ è½½å¤±è´¥", err);
    }
  }
  
  // é¡µé¢åŠ è½½æ—¶å…ˆç”¨ç¼“å­˜æ›´æ–°
  updateFromCache();
  
  // ç„¶åå°è¯•æ‹‰å–å®æ—¶æ•°æ®
  fetchSolBalance(); // å¦‚æœæ¥å£å¯ç”¨ï¼Œä¼šè¦†ç›–ç¼“å­˜æ•°æ®

  drawBalanceChart();
  setInterval(fetchSolBalance, 30000);
  
  function toggleDarkMode() { document.body.classList.toggle('dark-mode'); }
</script>

</body>
</html>
